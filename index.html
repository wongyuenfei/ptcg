<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PTCG ç·´ç¿’å¹³å°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #121212;
      margin: 0;
      padding: 10px;
      color: #ffd700;
      user-select: none;
    }
    .main-layout {
      display: flex;
      height: 100vh;
    }
    .left-sidebar {
      width: 200px;
      background-color: #1e1e1e;
      padding: 12px;
      overflow-y: auto;
    }
    .game-board {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
 #coin {
    width: 100px;
    height: 100px;
    margin: 20px auto;
    border-radius: 50%;
    background-color: gold;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #121212;
    border: 3px solid #ffd700;
    box-shadow: 0 0 10px #ffd700;
    transition: transform 1s;
  }

  .flip-animation {
    animation: flip 1s ease-in-out;
  }

  @keyframes flip {
    0%   { transform: rotateY(0deg); }
    50%  { transform: rotateY(1800deg); }
    100% { transform: rotateY(3600deg); }
  }

    .coin-button {
      display: block;
      width: 100%;
      padding: 8px;
      background-color: #3b3b3b;
      border: none;
      color: #fff;
      font-size: 16px;
      margin-top: 8px;
      cursor: pointer;
    }
    #coin-result {
      margin-top: 12px;
      font-weight: bold;
      color: #ffda6a;
    }

    
    #battlefield {
  max-width: 1200px;
  margin: auto;
  background: #1e1e1e;
  border: 2px solid #ffd700;
  border-radius: 8px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: relative;
  /* ğŸ”ºç¼ºäº† relative å°è‡´ absolute ä½ç½®åƒè€ƒéŒ¯èª¤ */
} 
    .area {
      display: flex;
      justify-content: space-between;
      position: relative;
    }
    .zone {
  background: #2a2a2a;
  border-radius: 6px;
  border: 1px solid #444;
  padding: 8px;
  min-height: 140px;
  min-width: 100px;
  display: flex;
  flex-wrap: wrap;
  position: relative;
}

/* âœ… è£œä¸Šé€™æ®µï¼Œè§£æ±ºå †ç–Šå¤±æ•ˆå•é¡Œ */
#discard:not(.expanded) {
  display: block;
}
    .zone-title {
      color: #ffd700;
      font-size: 14px;
      margin-bottom: 4px;
    }
    #hand .card,
    .card {
  height: 140px;
  width: 100px;
  background: #333;
  border-radius: 12px;
  border: 2px solid #ffd700;
  color: #ffd700;
  font-weight: bold;
  font-size: 14px;
  position: absolute;
  cursor: grab;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  flex-direction: column;
  text-align: center;
  padding: 5px;
  box-sizing: border-box;

  /* âœ… åŠ é€™ä¸€è¡Œ */
  transition: transform 0.2s ease;
}

.card.hover-zoom {
  transform: scale(5);
  z-index: 1000;
}

    .card img {
      max-width: 80px;
      max-height: 100px;
      margin-bottom: 4px;
      border-radius: 6px;
      pointer-events: none;
      user-select: none;
    }
    #deck {
      height: 140px;
      width: 100px;
      background: #222;
      border-radius: 12px;
      border: 2px solid #ffd700;
      color: #ffd700;
      font-weight: bold;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      margin: 10px;
    }
    #deck span {
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 12px;
    }
    #deck-menu {
      position: absolute;
      top: 0;
      left: 110%;
      background: #2c2c2c;
      border-radius: 8px;
      padding: 10px;
      display: none;
      flex-direction: column;
      box-shadow: 0 0 10px #0008;
      z-index: 2000;
      border: 1px solid #ffd700;
      min-width: 200px;
    }
    #deck-menu button {
      background-color: #1b1b1b;
      border: 1px solid #ffd700;
      color: #ffd700;
      font-weight: bold;
      font-size: 14px;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 6px;
      user-select: none;
      white-space: nowrap;
      text-align: center;
      width: 100%;
    }
    #deck-menu button:hover {
      background-color: #333;
    }
    #prize .card {
    position: absolute;
    top: 0;
    left: 0;
    transform: translate(calc(var(--offset, 0px)), calc(var(--offset, 0px)));
    z-index: var(--z, 0);
    }  

    #prize-counter {
  position: absolute;
  top: -6px;
  right: -10px;
  background-color: #ffd700;
  color: #121212;
  padding: 2px 6px;
  font-size: 12px;
  border-radius: 8px;
  font-weight: bold;
  display: none;
  z-index: 10;
}
#discard .card {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 0;
}

/* æ£„ç‰Œå€ æœªå±•é–‹æ™‚ å¯å †ç–Š */
#discard:not(.expanded) {
  display: block;  /* ç§»é™¤ flex æ’åˆ— */
}
#discard:not(.expanded) .card {
  position: absolute;
  top: 0;
  left: 0;
  transform: translate(calc(var(--offset, 0px)), calc(var(--offset, 0px)));
  z-index: var(--z, 0);
}

/* å±•é–‹ç‹€æ…‹ï¼šæ”¹ç‚ºæ­£å¸¸æµå¼æ’åˆ— */
#discard.expanded {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
}
#discard.expanded .card {
  position: static !important;
  margin: 4px;
  transform: none !important;
  z-index: auto !important;
}
#discard.expanded .card:hover {
  outline: 2px solid #ffd700;
  background-color: #444;
  cursor: pointer;
}

.token {
  width: 40px;
  height: 40px;
  background-color: crimson;
  border-radius: 50%;
  color: white;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: grab;
  user-select: none;
}

#damage-bin {
  border: 1px dashed #888;
  padding: 8px;
  margin-top: 10px;
}
    
  </style>
</head>
<body>
  <div class="main-layout">
    <div class="left-sidebar">
      <div id="coin">?</div>
<button class="coin-button" onclick="flipCoin()">æ“²ç¡¬å¹£ï¼</button>
<p id="coin-result">çµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡</p>

<div style="margin-top: 20px;">
  <h3>å‚·å®³æŒ‡ç¤ºç‰©</h3>
  <div id="damage-bin" style="display: flex; flex-wrap: wrap; gap: 8px;">
    <div class="token" draggable="true" data-damage="10">10</div>
    <div class="token" draggable="true" data-damage="20">20</div>
    <div class="token" draggable="true" data-damage="30">30</div>
    <div class="token" draggable="true" data-damage="50">50</div>
    <div class="token" draggable="true" data-damage="100">100</div>
  </div>
</div>
    </div>

    

    <div class="game-board">
      <div id="battlefield">
        <!-- â¬‡ï¸ ä½ å¯ä»¥å°‡å®Œæ•´ battle å€å¡Šæ’å…¥é€™è£¡ â¬‡ï¸ -->
          <!-- ä¸Šå€ï¼šä¸»æˆ°å€ã€ä¸­é–“æ˜¯ä¸»æˆ°ã€å·¦é‚Šçè³ã€å³é‚Šå ´åœ° -->
  <div class="area" id="top-area">
    <div>
      <div class="zone-title">çè³å¡å€</div>
<div style="position: relative; display: inline-block;">
  <div id="prize" class="zone"></div>
  <div id="prize-counter">x0</div>
</div>
    </div>
    <div>
      <div class="zone-title">ä¸»æˆ°å€</div>
      <div id="active" class="zone"></div>
    </div>
    <div>
      <div class="zone-title">å ´åœ°å¡å€</div>
      <div id="stadium" class="zone"></div>
    </div>
  </div>

  <!-- ä¸­å€ï¼šå·¦ç‰Œåº«ï¼Œä¸­é–“å‚™æˆ°ï¼Œå³æ£„ç‰Œ -->
  <div class="area" id="middle-area">
    <div>
      <div class="zone-title">ç‰Œåº«</div>
      <div id="deck">
        ç‰Œåº« <span id="deck-count">0</span>
        <div id="deck-menu">
          <button id="peekAndPick">çœ‹ä¸Šé¢Nå¼µä¸¦é¸Nå¼µ</button>
          <button id="draw7">æŠ½ 7 </button>
          <button id="draw1">æŠ½ 1 </button>
          <button id="shuffle">æ´—ç‰Œ</button>
          <button id="pickCard">é¸æ“‡ä¸€å¼µå¡</button>
          <button id="moveToPrize">æ”¾åˆ°çè³å€</button>
          <button id="returnAllHand">å…¨æ”¾å›ç‰Œåº«</button>
          <button id="returnHandToBottom">æ”¾è‡³ç‰Œåº«ä¸‹æ–¹</button>
        </div>
      </div>
    </div>
    <div style="flex-grow:1;">
      <div class="zone-title">å‚™æˆ°å€</div>
      <div id="bench" class="zone"></div>
    </div>
    <div>
      <div class="zone-title">æ£„ç‰Œå€</div>
      <div id="discard" class="zone"></div>
    </div>
  </div>

  <!-- ä¸‹å€ï¼šæ‰‹ç‰Œ -->
  <div class="area" id="bottom-area">
    <div style="width: 100%;">
      <div class="zone-title">æ‰‹ç‰Œå€</div>
      <div id="hand" class="zone" style="min-height: 160px;"></div>
    </div>
  </div>
      </div>
    </div>


  </div>

  <script>
   function flipCoin() {
    const coin = document.getElementById("coin");
    const resultText = document.getElementById("coin-result");

    // æ¸…é™¤èˆŠå‹•ç•«
    coin.classList.remove("flip-animation");
    void coin.offsetWidth; // è§¸ç™¼ reflow ä¾†é‡æ–°å•Ÿå‹•å‹•ç•«

    // åŸ·è¡Œå‹•ç•«
    coin.classList.add("flip-animation");

    // éš¨æ©Ÿçµæœï¼ˆå»¶é²é¡¯ç¤ºï¼‰
    setTimeout(() => {
      const isHeads = Math.random() < 0.5;
      coin.textContent = isHeads ? "æ­£é¢" : "åé¢";
      resultText.textContent = `çµæœæ˜¯ï¼š${isHeads ? "æ­£é¢" : "åé¢"}`;
    }, 1000); // é…åˆå‹•ç•«æ™‚é–“
  }


    
    let deck = [];
const zones = {
  hand: document.getElementById("hand"),
  bench: document.getElementById("bench"),
  active: document.getElementById("active"),
  prize: document.getElementById("prize"),
  discard: document.getElementById("discard"),
  stadium: document.getElementById("stadium"),
};

const zoneCards = { hand: [], bench: [], active: [], prize: [], discard: [], stadium: [] };
const deckElem = document.getElementById("deck");
const deckMenu = document.getElementById("deck-menu");
const deckCountElem = document.getElementById("deck-count");

// ç›£è½å„å€åŸŸçš„ dragover èˆ‡ drop äº‹ä»¶
for (const zoneName in zones) {
  const zoneElem = zones[zoneName];
  zoneElem.addEventListener("dragover", e => e.preventDefault());

  zoneElem.addEventListener("drop", e => {
    e.preventDefault();
    const data = JSON.parse(e.dataTransfer.getData("text/plain"));
    const fromZone = data.fromZone;
    const cardObj = data.card;

    // ç§»é™¤ä¾†æºå€å¡Šçš„å¡ç‰Œ DOM èˆ‡é™£åˆ—
    const idx = zoneCards[fromZone].findIndex(c => c.cardObj['å¡å'] === cardObj['å¡å']);
    if (idx !== -1) {
      const { cardDiv } = zoneCards[fromZone][idx];
      zones[fromZone].removeChild(cardDiv);
      zoneCards[fromZone].splice(idx, 1);

      if (fromZone === "prize") updatePrizeStacking();
      if (fromZone === "discard") updateDiscardStacking();
    }

    // å¾çè³å€ç§»åˆ°æ‰‹ç‰Œè¦ç”¨ addCardToZone ç‰¹æ®Šè™•ç†ï¼ˆå¦‚æœæœ‰éœ€è¦ï¼‰
    if (fromZone === "prize" && zoneName === "hand") {
      addCardToZone(cardObj, "hand");
    } else {
      addCardToZone(cardObj, zoneName);
    }
  });
}

// ç‰Œåº«å€å¯æ‹–å…¥ï¼ˆåŠ å…¥ç‰Œåº«æœ€é ‚ç«¯ï¼‰
deckElem.addEventListener("dragover", e => e.preventDefault());
deckElem.addEventListener("drop", e => {
  e.preventDefault();
  const data = JSON.parse(e.dataTransfer.getData("text/plain"));
  const fromZone = data.fromZone;
  const cardObj = data.card;

  const idx = zoneCards[fromZone].findIndex(c => c.cardObj['å¡å'] === cardObj['å¡å']);
  if (idx !== -1) {
    const { cardDiv } = zoneCards[fromZone][idx];
    zones[fromZone].removeChild(cardDiv);
    zoneCards[fromZone].splice(idx, 1);
    if (fromZone === "prize") updatePrizeStacking();
    if (fromZone === "discard") updateDiscardStacking();
  }

  deck.unshift(cardObj);
  updateDeckCount();
});

// å¡ç‰ŒåŠ å…¥æŒ‡å®šå€åŸŸï¼Œå»ºç«‹ DOMã€æ‹–æ›³äº‹ä»¶ã€æ’ç‰ˆã€å †ç–Šæ›´æ–°
function addCardToZone(cardObj, zoneName) {
  if (zoneName === "prize" && zoneCards["prize"].length >= 6) {
    alert("çè³å¡å€æœ€å¤šåªèƒ½æ”¾ 6 å¼µï¼");
    return;
  }

  const zoneElem = zones[zoneName];
  const cardDiv = document.createElement("div");
  cardDiv.className = "card";

  if (zoneName === "prize") {
    cardDiv.textContent = "èƒŒé¢å¡ç‰Œ";
  } else {
    const img = document.createElement("img");
    img.src = cardObj['åœ–ç‰‡ç¶²å€'] || "https://via.placeholder.com/80x100?text=No+Image";
    cardDiv.appendChild(img);
    const nameDiv = document.createElement("div");
    nameDiv.textContent = cardObj['å¡å'] || "æœªçŸ¥å¡ç‰Œ";
    cardDiv.appendChild(nameDiv);
  }

  cardDiv.draggable = true;
  cardDiv.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", JSON.stringify({ card: cardObj, fromZone: zoneName }));
    cardDiv.style.opacity = "0.5";
  });
  cardDiv.addEventListener("dragend", () => {
    cardDiv.style.opacity = "1";
  });

  zoneElem.appendChild(cardDiv);
  zoneCards[zoneName].push({ cardObj, cardDiv });

  repositionCards(zoneName);

  if (zoneName === "prize") updatePrizeStacking();
  if (zoneName === "discard") updateDiscardStacking();
}

// çè³å€å †ç–ŠåŠæ•¸é‡é¡¯ç¤º
function updatePrizeStacking() {
  const prizeCards = zoneCards["prize"].map(c => c.cardDiv);
  prizeCards.forEach((card, i) => {
    const offset = i * 5;
         card.style.setProperty("--offset", `${offset}px`);
    card.style.setProperty("--z", i);
  });

  const counter = document.getElementById("prize-counter");
  if (prizeCards.length > 0) {
         counter.textContent = `x${prizeCards.length}`;
    counter.style.display = "block";
  } else {
    counter.style.display = "none";
  }
}

// æ£„ç‰Œå€å †ç–Šå’Œå±•é–‹ç‹€æ…‹åˆ‡æ›
function updateDiscardStacking() {
  const discard = document.getElementById("discard");
  const discardCards = zoneCards["discard"].map(c => c.cardDiv);

  if (!discard.classList.contains("expanded")) {
    discardCards.forEach((card, index) => {
      const offset = index * 3;
      card.style.position = "absolute";
      card.style.setProperty("--offset", `${offset}px`);
      card.style.setProperty("--z", index);
    });
  } else {
    discardCards.forEach(card => {
      card.style.position = "static";
      card.style.removeProperty("--offset");
      card.style.removeProperty("--z");
    });
  }
}

// ä¸€èˆ¬å€åŸŸå¡ç‰Œé‡æ–°æ’ç‰ˆï¼ˆé™¤äº†çè³å€ï¼‰
function repositionCards(zoneName) {
   if (zoneName === "prize" || zoneName === "discard") return; 

  const zoneElem = zones[zoneName];
  const cards = zoneCards[zoneName].map(c => c.cardDiv);
  const cardWidth = 110;
  const startX = Math.max((zoneElem.clientWidth - cards.length * cardWidth) / 2, 0);
  cards.forEach((card, i) => {
    card.style.position = "absolute";
    card.style.left = (startX + i * cardWidth) + "px";
    card.style.top = "0px";
  });
}

// ç‰Œåº«æ•¸é‡é¡¯ç¤ºæ›´æ–°
function updateDeckCount() {
  deckCountElem.textContent = deck.length;
}

// æ´—ç‰Œ
function shuffleDeck() {
  for (let i = deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }
  alert("å·²æ´—ç‰Œï¼");
  updateDeckCount();
}

// æŠ½å¡ï¼ˆnå¼µï¼‰
function drawCards(n) {
  for (let i = 0; i < n; i++) {
    if (deck.length === 0) {
      alert("ç‰Œåº«å·²ç©ºï¼");
      break;
    }
    const card = deck.shift();
    addCardToZone(card, "hand");
  }
  updateDeckCount();
}

// è¼¸å…¥å¡åæ‰¾å¡ä¸¦åŠ å…¥æ‰‹ç‰Œ
function pickCardFromDeck() {
  const name = prompt("è¼¸å…¥å¡åï¼š");
  const idx = deck.findIndex(c => c['å¡å'] === name);
  if (idx !== -1) {
    const card = deck.splice(idx, 1)[0];
    addCardToZone(card, "hand");
    updateDeckCount();
  } else {
    alert("æ‰¾ä¸åˆ°é€™å¼µå¡ï¼");
  }
}

// æŒ‰éˆ•äº‹ä»¶ç¶å®š
document.getElementById("draw7").onclick = e => { e.stopPropagation(); drawCards(7); };
document.getElementById("draw1").onclick = e => { e.stopPropagation(); drawCards(1); };
document.getElementById("shuffle").onclick = e => { e.stopPropagation(); shuffleDeck(); };
document.getElementById("pickCard").onclick = e => { e.stopPropagation(); pickCardFromDeck(); };
document.getElementById("returnAllHand").onclick = e => {
  e.stopPropagation();
  const hand = zoneCards["hand"];
  hand.forEach(({ cardObj, cardDiv }) => {
    zones["hand"].removeChild(cardDiv);
    deck.push(cardObj);
  });
  zoneCards["hand"] = [];
  shuffleDeck();
};

document.getElementById("returnHandToBottom").onclick = e => {
  e.stopPropagation();
  const hand = zoneCards["hand"];
  if (hand.length === 0) {
    alert("æ‰‹ç‰Œå€æ²’æœ‰å¡ç‰Œï¼");
    return;
  }
  hand.forEach(({ cardObj, cardDiv }) => {
    zones["hand"].removeChild(cardDiv);
    deck.push(cardObj); // æ”¾ç‰Œåº«åº•éƒ¨
  });
  zoneCards["hand"] = [];
  updateDeckCount();
};
document.getElementById("peekAndPick").onclick = e => {
  e.stopPropagation();
  if (deck.length === 0) return alert("ç‰Œåº«ç©ºäº†ï¼");
  const peekN = parseInt(prompt("æŸ¥çœ‹å¹¾å¼µï¼Ÿ"));
  const pickN = parseInt(prompt("å¾ä¸­é¸æ“‡å¹¾å¼µï¼Ÿ"));
  if (isNaN(peekN) || isNaN(pickN) || peekN <= 0 || pickN <= 0) return alert("è¼¸å…¥éŒ¯èª¤ï¼");
  const topCards = deck.slice(0, peekN);
     const names = topCards.map((c, i) => `${i + 1}: ${c['å¡å']}`).join('\n');
   const indices = prompt(`è«‹è¼¸å…¥è¦é¸çš„å¡ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰ï¼š\n${names}`);
  if (!indices) return;
  const idxs = indices.split(",").map(s => parseInt(s.trim()) - 1).filter(i => i >= 0 && i < peekN);
  if (idxs.length !== pickN) return alert("é¸æ“‡éŒ¯èª¤ï¼");
  // æŒ‰å¤§åˆ°å°é †åºå¾ç‰Œåº«ä¸­æŠ½å‡ºï¼Œé¿å…ç´¢å¼•éŒ¯äº‚
  const picked = idxs.sort((a, b) => b - a).map(i => deck.splice(i, 1)[0]);
  picked.reverse().forEach(c => addCardToZone(c, "hand"));
  updateDeckCount();
};
document.getElementById("moveToPrize").onclick = e => {
  e.stopPropagation();
  if (deck.length === 0) return alert("ç‰Œåº«å·²ç©ºï¼");
  const card = deck.shift();
  addCardToZone(card, "prize");
  updateDeckCount();
};

// è¼‰å…¥å¤–éƒ¨ CSV ç‰Œçµ„
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vThooKHKUDMsV3KmFG3yzv2npBf5kcRkr3_iOvo7H4spF3u76b4SjwHKNtwP4fJHDMTxr-g1kdgUDJm/pub?output=csv";

fetch(csvUrl)
  .then(res => res.text())
  .then(csv => {
    deck = parseCSV(csv);
    updateDeckCount();
    alert("ç‰Œçµ„è¼‰å…¥æˆåŠŸï¼Œå…± " + deck.length + " å¼µå¡ï¼");
  })
  .catch(err => {
    console.error("è®€å– CSV ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
    alert("ç„¡æ³•è¼‰å…¥å¡ç‰Œè³‡æ–™ï¼");
  });

// CSV è§£æ
function parseCSV(csvText) {
  const lines = csvText.trim().split("\n");
  const headers = lines[0].split(",");

  const deck = [];
  lines.slice(1).forEach(line => {
    const values = line.split(",");
    const obj = {};
    headers.forEach((header, i) => {
      obj[header.trim()] = values[i]?.trim();
    });
    
    // éæ¿¾æ‰æ²’æœ‰å¡åçš„ç©ºè¡Œ
    if (obj['å¡å'] && obj['å¡å'].trim() !== "" && obj['åœ–ç‰‡ç¶²å€'] && obj['åœ–ç‰‡ç¶²å€'].trim() !== "") {
      const quantity = parseInt(obj['æ•¸é‡']) || 1;
      const cardData = {
        'å¡å': obj['å¡å'].trim(),
        'å¡çµ„': obj['å¡çµ„'] || '',
        'å¡è™Ÿ': obj['å¡è™Ÿ'] || '',
        'åœ–ç‰‡ç¶²å€': obj['åœ–ç‰‡ç¶²å€'].trim()
      };
      
      // æ·»åŠ æŒ‡å®šæ•¸é‡çš„å¡ç‰Œ
      for (let i = 0; i < quantity; i++) {
        deck.push(cardData);
      }
    }
  });
  
  return deck;
}

// æ£„ç‰Œå€é»æ“Šäº‹ä»¶ï¼šå±•é–‹ï¼æ”¶èµ·ï¼Œä¸¦å…è¨±é»æ“Šå¡ç‰Œå›æ‰‹ç‰Œ
zones["discard"].addEventListener("click", e => {
  e.stopPropagation();
  const discard = zones["discard"];
  const isExpanded = discard.classList.toggle("expanded");
  updateDiscardStacking();

  if (isExpanded) {
    zoneCards["discard"].forEach(({ cardDiv, cardObj }) => {
      cardDiv.onclick = ev => {
        ev.stopPropagation();
        zones["discard"].removeChild(cardDiv);
        zoneCards["discard"] = zoneCards["discard"].filter(c => c.cardDiv !== cardDiv);
        addCardToZone(cardObj, "hand");
        discard.classList.remove("expanded");
        updateDiscardStacking();
      };
    });
  } else {
    zoneCards["discard"].forEach(({ cardDiv }) => cardDiv.onclick = null);
  }
});

// é»æ“Šå…¶ä»–åœ°æ–¹æ”¶èµ·æ£„ç‰Œå€
window.addEventListener("click", () => {
  const discard = zones["discard"];
  if (discard.classList.contains("expanded")) {
    discard.classList.remove("expanded");
    updateDiscardStacking();
    zoneCards["discard"].forEach(({ cardDiv }) => cardDiv.onclick = null);
  }
});

// é»æ“Šç‰Œåº«åˆ‡æ›é¸å–®é¡¯ç¤º
deckElem.addEventListener("click", e => {
  e.stopPropagation();
  deckMenu.style.display = deckMenu.style.display === "flex" ? "none" : "flex";
});
deckMenu.addEventListener("click", e => e.stopPropagation());
window.addEventListener("click", e => {
  if (!deckElem.contains(e.target) && !deckMenu.contains(e.target)) {
    deckMenu.style.display = "none";
  }
});

// æ»‘é¼ åœç•™è¶…é3ç§’æ‰æ”¾å¤§
document.addEventListener("mouseover", function (e) {
  const target = e.target.closest(".card");
  if (!target) return;

  // å¦‚æœå·²æœ‰è¨ˆæ™‚å™¨å°±æ¸…é™¤
  if (target.hoverTimer) clearTimeout(target.hoverTimer);

  // è¨­å®š3ç§’å¾Œæ‰åŠ ä¸Šæ”¾å¤§ class
  target.hoverTimer = setTimeout(() => {
    target.classList.add("hover-zoom");
  }, 1000);
});

document.addEventListener("mouseout", function (e) {
  const target = e.target.closest(".card");
  if (!target) return;

  // æ»‘é¼ é›¢é–‹æ™‚æ¸…é™¤è¨ˆæ™‚å™¨ä¸¦ç§»é™¤æ”¾å¤§
  if (target.hoverTimer) {
    clearTimeout(target.hoverTimer);
    target.hoverTimer = null;
  }
  target.classList.remove("hover-zoom");
});

document.addEventListener("DOMContentLoaded", () => {
  const battlefield = document.getElementById("battlefield");
  const damageBin = document.getElementById("damage-bin");

  // å»ºç«‹ä¸¦è¿”å›ä¸€å€‹å¯æ‹–æ›³çš„å‚·å®³æŒ‡ç¤ºç‰©
  function createDamageToken(amount) {
    const token = document.createElement("div");
    token.className = "token";
    token.textContent = amount;
    token.draggable = true;
    token.id = "token_" + Date.now(); // âœ… å”¯ä¸€ ID
    token.style.position = "absolute";
    token.style.cursor = "move";

    token.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", JSON.stringify({
        type: "reposition",
        amount,
        id: token.id
      }));
    });

    return token;
  }

  // ğŸŸ¡ æ‹–æ›³å‚·å®³ä¾†æº tokenï¼ˆé¢æ¿ä¸Šçš„ï¼‰- è¤‡è£½æ¨¡å¼
  document.querySelectorAll(".token").forEach(token => {
    token.addEventListener("dragstart", e => {
      e.dataTransfer.setData("text/plain", JSON.stringify({
        type: "damage",
        amount: token.dataset.damage
      }));
      // ä¸å¾åŸä½ç½®ç§»é™¤ï¼Œæ‰€ä»¥å¯ä»¥é‡è¤‡æ‹–æ›³
    });
  });

  // ğŸŸ¡ æ‹–æ›³æ”¾åˆ°æˆ°å ´å€åŸŸ
  battlefield.addEventListener("dragover", e => e.preventDefault());
  battlefield.addEventListener("drop", e => {
    e.preventDefault();
    const data = JSON.parse(e.dataTransfer.getData("text/plain"));

    if (data.type === "damage") {
      // å¾å‚·å®³å€è¤‡è£½ä¸€å€‹æ–°çš„ token åˆ°æˆ°å ´
      const token = createDamageToken(data.amount);

      const rect = battlefield.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      token.style.left = `${x}px`;
      token.style.top = `${y}px`;

      battlefield.appendChild(token);
    } else if (data.type === "reposition") {
      // ç§»å‹•å·²æ”¾ç½®çš„ token
      const token = document.getElementById(data.id);
      if (token) {
        const rect = battlefield.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        token.style.left = `${x}px`;
        token.style.top = `${y}px`;
      }
    }
  });

  // ğŸŸ¡ æ‹–æ›³å›ã€Œå‚·å®³å€ã€æ‰æœƒåˆªé™¤
  damageBin.addEventListener("dragover", e => {
    e.preventDefault();
    // æ·»åŠ è¦–è¦ºåé¥‹ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥æ”¾é–‹ä¾†åˆªé™¤
    damageBin.style.backgroundColor = "#444";
  });
  
  damageBin.addEventListener("dragleave", e => {
    // ç§»é™¤è¦–è¦ºåé¥‹
    damageBin.style.backgroundColor = "";
  });
  
  damageBin.addEventListener("drop", e => {
    e.preventDefault();
    damageBin.style.backgroundColor = ""; // ç§»é™¤è¦–è¦ºåé¥‹
    
    const data = JSON.parse(e.dataTransfer.getData("text/plain"));
    if (data.type === "reposition") {
      const token = document.getElementById(data.id);
      if (token) {
        // æ·»åŠ åˆªé™¤å‹•ç•«æ•ˆæœ
        token.style.transition = "opacity 0.3s ease";
        token.style.opacity = "0";
        setTimeout(() => {
          token.remove();
        }, 300);
      }
    }
  });
});
  </script>
</body>
</html>
